<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/"><i class="bi bi-hdd-stack-fill me-2"></i>Server Manager</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    {% if user_role == 'admin' %}
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('user_management') }}">User Management</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('manage_sections') }}">Section Management</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('export_servers_to_excel') }}"><i class="bi bi-file-earmark-excel"></i> Excel Export</a></li>
                    {% endif %}
                </ul>
                <span class="navbar-text text-white me-3">Welcome, {{ session.username }}!</span>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-light"><i class="bi bi-box-arrow-right me-2"></i>Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        {% if user_role == 'admin' %}
        <div class="card mb-4">
            <div class="card-header"><h5 class="mb-0"><button class="btn btn-link text-decoration-none text-dark fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#addServerCollapse">Add New Server <i class="bi bi-plus-circle"></i></button></h5></div>
            <div id="addServerCollapse" class="collapse">
                <div class="card-body p-4">
                    <form action="{{ url_for('add_server') }}" method="POST">
                        <h6 class="text-muted">Server Details</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-4"><input type="text" class="form-control" name="server_name" placeholder="Server Name" required></div>
                            <div class="col-md-4"><input type="text" class="form-control" name="server_ip" placeholder="Server IP"></div>
                            <div class="col-md-4"><input type="text" class="form-control" name="domain" placeholder="Domain"></div>
                            <div class="col-md-4"><input type="text" class="form-control" name="port" placeholder="Port" required></div>
                            <div class="col-md-4"><select name="access_level" class="form-select" required><option value="" disabled selected>Access Level</option><option value="Level1">Level 1</option><option value="Level2">Level 2</option></select></div>
                            <div class="col-md-4"><select name="section" class="form-select"><option value="" selected>Select Section</option>{% for section in sections %}<option value="{{ section }}">{{ section }}</option>{% endfor %}</select></div>
                        </div>
                        <hr>
                        <h6 class="text-muted">Credentials (fill at least one)</h6>
                        <div class="row g-3">
                            <div class="col-md-6 border-end pe-4">
                                <strong><i class="bi bi-reception-4 me-1"></i> Local Host</strong>
                                <input type="text" class="form-control mt-2" name="ip_username" placeholder="Username for IP">
                                <input type="text" class="form-control mt-2" name="ip_password" placeholder="Password for IP">
                            </div>
                            <div class="col-md-6 ps-4">
                                <strong><i class="bi bi-globe me-1"></i> For Domain</strong>
                                <input type="text" class="form-control mt-2" name="domain_username" placeholder="Username for Domain">
                                <input type="text" class="form-control mt-2" name="domain_password" placeholder="Password for Domain">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-4"><i class="bi bi-plus-lg me-2"></i>Add Server</button>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Server Name</th>
                                <th>IP / Domain</th>
                                <th>Credentials</th>
                                <th>Port</th>
                                <th>Section</th>
                                {% if user_role == 'admin' %}<th>Actions</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for section, server_list in servers_by_section.items() %}
                            <tr class="table-group-divider">
                                <td colspan="{% if user_role == 'admin' %}6{% else %}5{% endif %}" class="bg-light">
                                    <h5 class="mb-0 py-1">{{ section }}</h5>
                                </td>
                            </tr>
                                {% for server in server_list %}
                                <tr>
                                    <td><strong>{{ server.server_name }}</strong></td>
                                    <td>
                                        {% if server.server_ip %}<div><i class="bi bi-reception-4 me-2 text-muted"></i>{{ server.server_ip }}</div>{% endif %}
                                        {% if server.domain %}<div class="mt-1"><i class="bi bi-globe me-2 text-muted"></i>{{ server.domain }}</div>{% endif %}
                                    </td>
                                    <td class="credentials-cell">
                                        {% if server.ip_username or server.ip_password %}
                                        <div class="credential-group">
                                            <div class="credential-header"><span class="badge bg-secondary me-2">IP</span> Credentials</div>
                                            <div class="credential-item">
                                                <span><i class="bi bi-person me-2 text-muted"></i>Username</span>
                                                <div>
                                                    <code>{{ server.ip_username }}</code>
                                                    <button class="icon-button ms-1" onclick="copyToClipboard('{{ server.ip_username }}')" title="Copy Username"><i class="bi bi-clipboard"></i></button>
                                                </div>
                                            </div>
                                            <div class="credential-item">
                                                <span><i class="bi bi-key me-2 text-muted"></i>Password</span>
                                                <div>
                                                    <code>{{ server.ip_password }}</code>
                                                    <button class="icon-button ms-1" onclick="copyToClipboard('{{ server.ip_password }}')" title="Copy Password"><i class="bi bi-clipboard"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% if server.domain_username or server.domain_password %}
                                        <div class="credential-group {% if server.ip_username or server.ip_password %}mt-2{% endif %}">
                                            <div class="credential-header"><span class="badge bg-info me-2">Domain</span> Credentials</div>
                                            <div class="credential-item">
                                                <span><i class="bi bi-person me-2 text-muted"></i>Username</span>
                                                <div>
                                                    <code>{{ server.domain_username }}</code>
                                                    <button class="icon-button ms-1" onclick="copyToClipboard('{{ server.domain_username }}')" title="Copy Username"><i class="bi bi-clipboard"></i></button>
                                                </div>
                                            </div>
                                            <div class="credential-item">
                                                <span><i class="bi bi-key me-2 text-muted"></i>Password</span>
                                                <div>
                                                    <code>{{ server.domain_password }}</code>
                                                    <button class="icon-button ms-1" onclick="copyToClipboard('{{ server.domain_password }}')" title="Copy Password"><i class="bi bi-clipboard"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td><span class="badge bg-light text-dark">{{ server.port }}</span></td>
                                    <td><span class="badge rounded-pill text-bg-success">{{ server.section }}</span></td>
                                    {% if user_role == 'admin' %}
                                    <td>
                                        <button type="button" class="btn btn-primary btn-sm icon-button me-2" title="Edit Server" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editServerModal"
                                                data-id="{{ server.id }}"
                                                data-name="{{ server.server_name }}"
                                                data-ip-user="{{ server.ip_username }}"
                                                data-domain-user="{{ server.domain_username }}">
                                            <i class="bi bi-pencil-square fs-5"></i>
                                        </button>
                                        <form action="{{ url_for('delete_server', server_id=server.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this server?');" style="display: inline;">
                                            <button type="submit" class="btn btn-danger btn-sm icon-button" title="Delete Server"><i class="bi bi-trash fs-5"></i></button>
                                        </form>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            {% else %}
                            <tr><td colspan="8" class="text-center p-5 text-muted">No servers to display.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editServerModal" tabindex="-1" aria-labelledby="editServerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editServerModalLabel">Edit Server</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editServerForm" method="POST">
                        <input type="hidden" name="server_id" id="editServerId">
                        <div class="mb-3">
                            <label for="editServerName" class="form-label">Server Name</label>
                            <input type="text" class="form-control" id="editServerName" name="server_name" required>
                        </div>
                        <hr>
                        <h6 class="text-muted">Edit Credentials (leave password blank to keep unchanged)</h6>
                        <div class="row g-3">
                            <div class="col-md-6 border-end pe-4">
                                <strong><i class="bi bi-reception-4 me-1"></i> Local Host Credentials</strong>
                                <div class="mt-2">
                                    <label for="editIpUsername" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="editIpUsername" name="ip_username">
                                </div>
                                <div class="mt-2">
                                    <label for="editIpPassword" class="form-label">New Password</label>
                                    <input type="text" class="form-control" id="editIpPassword" name="ip_password" placeholder="Enter new password to change">
                                </div>
                            </div>
                            <div class="col-md-6 ps-4">
                                <strong><i class="bi bi-globe me-1"></i> Domain Credentials</strong>
                                <div class="mt-2">
                                    <label for="editDomainUsername" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="editDomainUsername" name="domain_username">
                                </div>
                                <div class="mt-2">
                                    <label for="editDomainPassword" class="form-label">New Password</label>
                                    <input type="text" class="form-control" id="editDomainPassword" name="domain_password" placeholder="Enter new password to change">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer mt-4">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                console.log('Text copied to clipboard');
            } catch (err) {
                console.error('Failed to copy: ', err);
            }
        }

        const editServerModal = document.getElementById('editServerModal');
        if (editServerModal) {
            editServerModal.addEventListener('show.bs.modal', event => {
                const button = event.relatedTarget;
                const serverId = button.getAttribute('data-id');
                const serverName = button.getAttribute('data-name');
                const ipUser = button.getAttribute('data-ip-user');
                const domainUser = button.getAttribute('data-domain-user');
                
                const modalTitle = editServerModal.querySelector('.modal-title');
                const modalForm = editServerModal.querySelector('#editServerForm');
                
                modalTitle.textContent = `Edit Server: ${serverName}`;
                
                modalForm.action = `/server/edit/${serverId}`;
                modalForm.querySelector('#editServerId').value = serverId;
                modalForm.querySelector('#editServerName').value = serverName;
                modalForm.querySelector('#editIpUsername').value = ipUser;
                modalForm.querySelector('#editDomainUsername').value = domainUser;
                
                modalForm.querySelector('#editIpPassword').value = '';
                modalForm.querySelector('#editDomainPassword').value = '';
            });
        }
    </script>
</body>
</html>